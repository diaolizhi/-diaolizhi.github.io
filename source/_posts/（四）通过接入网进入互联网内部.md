---
title: （四）通过接入网进入互联网内部
date: 2017-8-10
categories: 计算机网络
---
本章我们将学习网络包是如何通过互联网接入路由器，最终进入互联网内部的。

<!--more-->
# 本章看点
- ADSL 接入网的结构和工作方式
- 光纤接入网（FTTH）
- 接入网中使用的 PPP 和隧道
- 网络运营商的内部
- 跨越运行商的网络包

# 一、ADSL 接入网的结构和工作方式
## 什么是接入网？
我们讨论的是 ADSL 接入网的结构和工作方式，那么什么是接入网？
实际上，接入网就是用户和互联网之间的通信线路。常见的接入网方式包括：ADSL、FTTH。
## 从客户端到达互联网接入路由器
客户端生成的网络包先经过集线器和交换机到达互联网接入路由器，并在此从以太网包中取出 IP 包判断转发目标。互联网接入路由器会在网络包前面加上 MAC 头部，PPPoE 头部，PPP 头部总共 3 中头部，然后发送给 ADSL Modem。
## 到达 ADSL Modem（调制解调器）
ADSL Modem 将包拆分成信元，并转换成电信号发送给分离器。
## 到达分离器
当信号通过分离器发送出去的时候，电话和 ADSL 信号只是同时流到一条线路上而已，分离器并没有做什么事情。而在另一头，分离器的作用就是将电话和 ADSL 信号分离，防止它们相互干扰。
## 到达电话局
到达电话局之后，会经过配线盘和分离器到达 DSLAM（相当于多个 ADSL Modem）。
从 DSLAM 出来以后，会到达一个叫 BAS 的包转发设备。这两个都具有 ATM 接口。到这里 BAS 的接收工作就完成了，它会丢弃 MAC 头部和 PPPoE 头部，接下来，BAS 会在包的前面加上隧道专用头部，并发送到隧道的出口。然后网络包会到达隧道出口的隧道专用路由器，在这里隧道头部会被去掉，IP 包会被取出，并转发到互联网内部。
## 总结
客户端->接入网路由器->ADSL Modem->分离器->电话电缆->配线盘->分离器->DSLAM->BAS->隧道->隧道专用路由器->互联网内部
# 二、光纤接入网（FTTH）
## 光纤的基本知识
光信号很容易表示数字信息，亮表示 1，暗表示 0。数字信息转换成电信号再转换成光信号，在接收端的光敏元件可以感光，并根据明暗产生响应的电压和电流，这些电信号会被还原成数字信号。
## 单模和多模
原理我看不懂，总之多模光纤可以传导多条光线，可以降低成本，但是信号的失真会大。单模光纤反之。因此，多模光纤主要用于一座建筑物里面的连接，单模光纤用于距离较远的建筑物之间的连接。FTTH 使用的是单模光纤。
## FTTH 的两种形态
### 第一种
客户端->互联网接入路由器->光纤收发器（电信号转化成光信号）->一条光纤->多路光纤收发器（光信号转化成电信号）->BAS->互联网内部

这种方式下，响应包的光信号也是沿着同一条光纤传输到用户端，上行信号和下行信号会混合导致无法识别，办法是采用不同波长的光，再用棱镜原理分离。这种方式叫做**波分复用**。
### 第二种
客户端->互联网接入路由器->ONU->分光器->OLT->BAS->互联网内部

ONU 可以将电信号转化为光信号，会根据 OLT 的指令来发送数据。

当 OLT 发送数据给用户时，分光器会发送给所用用户，所以需要在每个包前面加上用于识别的 ONU 的信息，当 ONU 收到信号后，接收发给自己的信号，并转换成以太网信号。

当使用 PPPoE 来传输包时，其工作过程和 ADSL 类似。

# 三、接入网中使用的 PPP 和隧道
## BAS 和 PPPoE 协议
在 ADSL 和 FTTH 接入网中，都需要连接到 BAS。BAS 实际是一个路由器，但是还具备了用户认证和配置下发的功能。BAS 使用 PPPoE 来实现登录功能，而 PPPoE 是有传统电话拨号上网使用的 PPP 协议发展而来的。
## PPP 协议具体过程
- 用户向运营商的接入点拨打电话
- 电话接通后输入用户名和密码进行登录
- 用户名和密码通过 RADIUS 协议从 RAS 发送到认证服务器
- 确认无误后，认证服务器会返回 IP 地址等配置信息，并将这些信息下发给用户
- 用户根据这些信息配置 IP 地址等参数，就可以发送 TCP/IP 包了
## PPP 协议是如何传输消息的
PPP 协议中没有定义以太网中报头和 FCS 等元素，也没有定义信号的合适，所以无法将 PPP 消息转化为信号来发送。于是 PPP 在拨号接入中借用了 HDLC 协议作为容器，使得 PPP 消息可以传输。
## PPPoE 的诞生
借助 HDLC 发送 PPP 消息只能在拨号接入中使用，ADSL 和 FTTH 并不能使用 HDLC，因此需要另一种方法来发送 PPP 消息。此外，以太网和 PPP 在设计上有所不同，为了弥补这些问题就重新设计了一个新的规格，这就是 PPPoE。

PPPoE 就是将 PPP 消息装入以太网包进行传输的方式。
## 通过隧道将网络包发送给运营商
BAS 除了具有用户认证和下发配置的功能以外，还可以使用隧道方式来传输网络包。

所谓隧道，就类似于套接字之间建立的 TCP 连接，从一侧发送数据，数据会从另一侧原封不动地出来。

隧道的实现除了 TCP 连接之外，还有基于封装的隧道实现方法。
## 接入网的整体工作过程
- 接入路由器根据 PPPoE 的发现机制来寻找 BAS，这一机制和 ARP 一样基于广播来实现
- 得到 BAS 的 MAC 地址之后，就可以和 BAS 进行通信
- 用户端发送用户名和密码
- BAS 发送 IP 地址，DNS 服务器的 IP 地址，默认网关的 IP 地址给用户
- 发送网络包时，路由器不是按照以太网的规则转发，而是按照 PPPoE 规则转发。
[MAC 头部]-[PPPoE 头部]-[PPP 头部]-[IP 头部]-[TCP 头部]-[数据]
- BAS 收到用户路由器发送的网络包之后，会去掉 MAC 头部和 PPPoE 头部，然后用隧道机制将包发送给网络运营商的路由器
## 除 PPPoE 之外的其他方式
PPPoA 方式不添加 MAC 头部和 PPPoE 头部，而是直接将包装入信元中。
还有一种 DHCP 方式，它不使用 PPP，而是将以太网包直接转换成 ADSL 信号发送给 DSLAM。

# 四、网络运营商的内部
## POP 和 NOC
POP 是接入网与运营商相连的设备。
NOC 是运营商的核心设备。
他们都是路由器。
## 室外通信线路的连接
室内的可以用线路直接相连，对于距离较远的 NOC 和 POP 来说，它们之间的连接方式可以分为几种：
- 自己拥有光纤，可以直接将 NOC 和 POP 连接起来
- 没有光纤的运营商可以租借其他运营商的通信线路（光纤可以复用）

# 五、跨越运营商的网络包
## 网络包的传递
到达 POP 路由器之后，根据路由表可以知道下一站发往哪里，可能是 POP 也可能使 NOC，可能会发送到另一个运营商，总之会到达目的地。
## 运营商之间的路由信息交换
运营商交换路由信息的方法是让相连的路由器相互告知路由信息就可以了。交换路由信息的过程是有路由器自动完成的，这里使用的机制称为 BGP（Border Gateway  Protocol 边界网关协议）
## 运营商信息交换的特点
运营商拥有一条线路，如果与所有路由器进行信息交换，那它们都可以使用这条线路了。实际上运营商之间的路由交换是在特定的路由器之间一对一进行的，这样一来，没交费的运营商就不能发送网络包过来了。
## IX 的必要性（Internet eXchange 互联网交换中心）
没有 IX 的情况下，每个运营商都要相互连接。有 IX 的情况下，每个运营商只要和 IX 相连就可以了。

IX 的实体是高性能交换机





















